<html>
<body>
 
 <pre>
 <b>NAME</b>
 
 elastico -- search and display loglines from Elasticsearch.
 
 <b>SYNOPSIS</b>
 
 <b>$> elastico -h | less -R</b>           # read this manual 
 
 <b>$> elastico -h html</b>                # get the manual as HTML page
 
 <b>$> elastico [-d] [-l num] [-t TIMESTRING] [-s] [-h|H] QUERY </b>
 
 <b>DESCRIPTION</b>
 The fastest way to start to use this program is to read 
 the examples section at the end of this document.
 
 The syntax of the QUERY is the so called "Lucene Query Syntax".
 It is almost indentical of the one accpeted by Kibana interface. 
 
 By default the search is made into the "lclslogs" index, 
 that is, we search into all log files lines stored in "psmetric01:/u2/logs"
 and processed by Elasticsearch.
 
 By default the search is made into the "src" field of each document.
 The field contains the log line as red from 'psmetric01:/u2/logs/*/*' .
 
 At the time of writing this text the "lclslogs" index contains
 the following fields: 
 
 <b>date</b>    : Date appearing in the logfile, extended to contain a guessed 
           value for the year.  
 
 <b>machine</b> : Machine producing the message. 
           (eg. psmetric01, psana101 etc. )
 
 <b>service</b> : Service producing the message. 
           (eg. cron, ... )
 
 <b>message</b> : The message part of a log line. 
           (eg. "Cannot create socket to [psmonit]:8020 -- Connection refused")
 
 <b>file</b>    : Logfile name where the message was found: 
           (eg. messages, cron, etc. )
 
 <b>src</b>     : To simplify the search by shell this field was added in a second
           phase. It contains the log line as it is recorded in 'psmetric01:/u2/logs/*/*'.
           eg:
  "Dec  5 14:57:27 psana1507 monit[6494]: Cannot create socket to [psmonit]:8020 -- Connection refused"  
 
 <b>PARAMETERS</b>
 
    <b>NOTE</b>. For all boolean parameters, that is parameters enabling or disabling a 
          feature, an upcase character means the opposite of its correspondant 
          lowercase character. Example: '-S' has the opposite effect of '-s'.
 
    <b>-d</b>  Shows <b>debug</b> informations. Intermediate values and global variables 
          that can simplify the understanding of the program in case something goes wrong.
          The debug information is printed at the end of the search results into STDERR.
 
    <b>-l</b>  Maximum number of <b>lines</b> to retrive from Elasticsearch. It must
        be a positive integer. Default to 20. The current maximum value is 10_000.
        This value is overridden by the '-t' parameter.
 
    <b>-h</b>  If given as the only parameter then the program will output 
        the documentation. If there are other parameters then the 
        matched words in output will be <b>highlight</b>ed. Words 
        of specific fields as e.g. machine:foo will not be highlithed,
        it only applies to the default <b>src</b> field. Default to false.
 
    <b>-s</b>  Asks Elasticsearch to <b>sort</b> the result not by relevence, as its 
        default but by time. Default to true.
 
    <b>-t</b>  <b>Time window</b>. With this parameters we can say we are 
        interested in restricting the search to the log of last 2 hours or 
        also between two explicit date-time points. This parameters overrided the 
        limit imposed by the '-l' parameter. The maxium number of results 
        obtainable is fiexd to 10_000. 
   
        There are three accepted syntaxes to specifiy the time window:
 
          1] Delta backward in time from present time.
                -t ABS_DELTA
                   ABS_DELTA matches regexp /\d+[dhm]/
 
                -t 10m             => search back 10 minutes 
 
          2] Delta backward/forward in time from a specified date-time instant.
                -t [YYYY]-[MMM]-[DD]-[HH:MM]__[+-]ABS_DELTA
                -t  2018-dec-10-10:30__-10m
                -t  dec-10__+3d 
 
          3] Explicit time window described by two date-time points. 
                -t [YYYY]-[MMM]-[DD]-[HH:MM]__[YYYY]-[MMM]-[DD]-[HH:MM]
                -t 2018-dec-10-15:50__2018-dec-15-16:30          
                -t dec-10__dec-15
                -t 14:30__15:15
 
        In general, when data is missing from a time point description values are 
        inferred from the current day. So dec-10 is auto completed to 2018-dec-10.       
 
        If the hour is missing then, on the left hand side of a '__' divider it is 
        auto-completed into the first second of the selected, on the right hand side of 
        a '__' divider it is autocompleted to the last second of the selected day. 
        
        Given the generality and flexibility of TIMESTRING it is better described
        by examples than by a formal grammar. See the Examples section.       
 
 
 <b>EXAMPLES</b>
 
 # Generic search over a word ... here a machine name 
 <b>$> elastico psana101        </b>
 
 # Generic search over a word ... here a service name 
 <b>$> elastico monit           </b>
 
 # Generic search over a wors ... here a user name    
 <b>$> elastico nmingott        </b>
 
 # Generic search over an approximate username 
 # Quote is necessary because "~" is special in bash.
 <b>$> elastic 'omar~'</b>
 
 # Generic search over everything that can be: psana101, psana103 etc.
 # observe that the quotes are fundamental to stop Bash from interpreting
 # "*". 
 <b>$> elastico 'psana*'        </b>
 
 # Search all log lines where there appear the work "nmingott" somwhere
 # AND the machine is a string which contains "metric".
 # Booleans MUST BE upcase words.
 <b>$> elastico 'nmingott AND machine:*metric*'</b>
 
 # Elaboration respect to the previous maching all line where "nmingott"
 # appers and the machine is a string containing *ana* or *metric*.
 # This examples shows that (...) is the syntax for  
 # grouping of booleans and that it is not necessary to write
 # (machine:*metric* OR machine:*ana*) in full.
 <b>$> elastico 'nmingott AND machine:(*metric* OR *ana*)'</b>
 
 # See last logs in psmetrico01
 <b>$> elastico 'machine:psmetric01'</b>
 
 # See the last 200 log lines in psmetric01
 <b>$> elastico -l 200 'machine:psmetric01'</b>
 
 # See the log lines that best metch a string,
 # return results according to Elasticsearch 'relevance' 
 # algorithm, not by date. In general, more time the string
 # is matched in the log line the more a line is 'relevant'.
 <b>$> elastico -S 'ana*' </b>
 
 # Hilight the search results 
 <b>$> elastico -l 20 -h 'wilko'</b>
 
 # Autocomplete only for a specific number of characters
 # In this case all 'psana' followed by 3 characters.
 <b>$> psana -h 'psana???'</b>
 
 # === <b>Time Window Selections</b> ===========
 
 # Show all logs related to 'psana???' in the last
 # 5 minutes. With the same syntax we can use the specifiers
 # <b>m</b> minutes, <b>h</b> hours, <b>d</b> days.
 <b>$> elastico -t 5m 'psana???'</b>
 
 # If we are unhappy about the result and suspect something
 # is wrong the first thing to do is to check how 'elastico' interpreted
 # the time window. The information is written after the search results, on STDERR.
 <b>$> elastico -d -t 5m 'psana???'</b>
 
 # We want to see the results moving around a specific
 # point in time. Suppose 5 minutes after 
 # the date 15 dic 2018 at 13:00
 <b>$> elastico -t 2018-dec-15-13:00__+5m 'psana???'</b>
 or, if we are still in 2018: 
 <b>$> elastico -t dec-15-13:00__+5m 'psana???'</b>
 
 # We want to see the results moving around a specific
 # point in time. Suppose 10 minutes before
 # the date 15 dic 2018 at 13:00
 <b>$> elastico -t 2018-dec-15-13:00__-10m 'psana???'</b>
 or, if we are still in 2018: 
 <b>$> elastico -t dec-15-13:00__-10m 'psana???'</b>
 
 # We want to see the results between two specific points in time 
 <b>$> elastico  -t 2018-dec-15-13:00__2018-dec-16-14:25 'psana101'</b>
 or, if we are still in 2018 
 <b>$> elastico  -t dec-15-13:00__dec-16-14:25 'psana101'</b>
 
 # We want to see the data in two specific date, all day hours.
 # If the hour is not specified and there are two specific date-time
 # points then the hour of the date on the left hand side is 00:00:00,
 # the hour for the right hand side is 23:59:59.
 <b>$> elastico  -t dec-15__dec-16 'psana103'</b>
 
 
 </pre>
</body>
</html>
